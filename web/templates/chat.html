{% extends "base.html" %}

{% block title %}Materna AI - Materna Minds{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="m-0">Chat</h2>

      <form method="post" action="{% url 'chat_clear' %}">
        {% csrf_token %}
        <button class="btn btn-outline-secondary btn-sm" type="submit">
          Clear
        </button>
      </form>
    </div>

    <div class="card shadow-sm">
      <div id="chatBody" class="card-body" style="height: 60vh; overflow-y: auto;">
        {% if messages %}
          {% for m in messages %}
            {% if m.role|default:'' == "user" %}
              <div class="d-flex justify-content-end mb-3">
                <div class="bg-primary text-white p-3 rounded-3" style="max-width: 80%;">
                  <div class="small opacity-75 mb-1">You</div>
                  <div style="white-space: pre-wrap;">{{ m.content|default:'' }}</div>
                </div>
              </div>
            {% else %}
              <div class="d-flex justify-content-start mb-3">
                <div class="bg-light border p-3 rounded-3" style="max-width: 80%;">
                  <div class="small text-muted mb-1">Assistant</div>
                  <div style="white-space: pre-wrap;">{{ m.content|default:'' }}</div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="text-center text-muted py-5">
            Start the conversation by sending a message.
          </div>
        {% endif %}
      </div>

      <div class="card-footer bg-white">
        <form id="chatForm" method="post" class="d-flex gap-2" autocomplete="off">
          {% csrf_token %}

          <input
            id="chatInput"
            type="text"
            name="message"
            class="form-control"
            placeholder="Type your message..."
            required
          />

          <button id="sendBtn" class="btn btn-primary" type="submit">
            Send
          </button>
        </form>

        {% if sources %}
          <div id="sourcesBlock" class="mt-3">
            <details>
              <summary class="text-muted">Sources used (latest reply)</summary>
              <div class="mt-2">
                <ul class="mb-0">
                  {% for s in sources %}
                    <li class="small">
                      <span class="fw-semibold">
                        {{ s.meta.source|default:"unknown" }} p.{{ s.meta.page|default:"?" }}
                      </span>
                      {% if s.score %}
                        <span class="text-muted">(score={{ s.score }})</span>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </details>
          </div>
        {% endif %}

        {% if error %}
          <div class="alert alert-danger mt-3 mb-0">
            {{ error }}
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<script>
  // Auto-scroll to the bottom whenever the page loads
  (function() {
    const el = document.getElementById("chatBody");
    if (el) el.scrollTop = el.scrollHeight;
  })();

  // Show typing indicator ONLY inside chat area for assistant
  (function() {
    const form = document.getElementById("chatForm");
    const sendBtn = document.getElementById("sendBtn");
    const input = document.getElementById("chatInput");
    const chatBody = document.getElementById("chatBody");
    const sources = document.getElementById("sourcesBlock");

    if (!form) return;

    form.addEventListener("submit", function() {
      if (!input.value.trim()) return;

      // Hide sources while waiting
      if (sources) sources.style.display = "none";

      // Disable UI to prevent double submits
      sendBtn.disabled = true;
      input.readOnly = true;

      // Add typing bubble in chat area
      const typingBubble = document.createElement("div");
      typingBubble.id = "typingBubble";
      typingBubble.className = "d-flex justify-content-start mb-3";
      typingBubble.innerHTML = `
        <div class="bg-light border p-3 rounded-3" style="max-width: 80%;">
          <div class="small text-muted mb-1">Assistant</div>
          <div class="d-flex align-items-center gap-2">
            <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
            <span class="text-muted">Thinking...</span>
          </div>
        </div>
      `;

      chatBody.appendChild(typingBubble);
      chatBody.scrollTop = chatBody.scrollHeight;
    });
  })();
</script>
{% endblock %}